function Trie(a){this.ch=a;this.word="";this.children={}}Trie.prototype.print=function(b){var e="<br/>";var a="&nbsp&nbsp";var f=new Array(b+1).join(a);var d=[];d.push(f+this.ch+":["+this.word+"]");for(var c in this.children){d.push(this.children[c].print(b+1))}return d.join(e)};Trie.prototype.insert=function(d,a){if(a>=d.length){return}var c=d.charAt(a);if(!(c in this.children)){this.children[c]=new Trie(c)}var b=this.children[c];if(a+1==d.length){b.word=d}else{b.insert(d,a+1)}};Trie.prototype.nextWord=function(){if(this.word!=""){return this.word}for(var a in this.children){return this.children[a].nextWord()}console.log("SHOULD NOT HAPPEN: this Trie contains an invalid leaf");return NaN};Trie.prototype._searchHelp=function(e,b,a){if(this.word!=""){a=this.word}if(b>=e.length){if(!a){return[b,this.nextWord()]}return[b,a]}var d=e.charAt(b);if(d in this.children){var c=this.children[d];return c._searchHelp(e,b+1,a)}return[b,a]};Trie.prototype.searchAndUpdate=function(c){var a=this._searchHelp(c,0,"");var e=a[0];var b=a[1];var d=c;if(e<c.length){d=c.substr(0,e)+"'"+c.substr(e,c.length-e)}return[b,d]};var WebInputMethod={hanzi:"",originalPinyin:"",pinyin:"",result:[],pageCurrent:1,pageSize:9,pageCount:0,initDict:function(){if(!pinyin_dict){throw"no dictionary file"}this.trie=new Trie("_");for(var a in pinyin_dict){this.trie.insert(a,0)}},initDom:function(){var b=document.querySelector("#web_input_method");var a=this;b.addEventListener("click",function(d){var c=d.target;if(c.nodeName=="LI"){a.chooseCharacter(parseInt(c.dataset.idx))}else{if(c.nodeName=="SPAN"){if(c.className=="page-up"&&a.pageCurrent>1){a.pageCurrent--;a.refreshPage()}else{if(c.className=="page-down"&&a.pageCurrent<a.pageCount){a.pageCurrent++;a.refreshPage()}}}}})},initKeyboard:function(){var d=document.querySelector(".show_keyboard");d.addEventListener("click",function(){var e=document.querySelector(".virtual_keyboard");if(e.style.display=="block"){e.style.display="none"}else{e.style.display="block"}});var c=this;var a=document.querySelectorAll(".virtual_keyboard p input");for(var b=0;b<a.length;b++){a[b].addEventListener("click",function(){var e=this.value;console.log(e);if(e>="A"&&e<="Z"){c.addChar(e.toLowerCase())}else{if(e=="<-"&&c.pinyin){c.delChar()}}})}},initAll:function(){this.initDict();this.initDom();this.initKeyboard();this._target=document.querySelector("#web_input_method");this._pinyinTarget=document.querySelector("#web_input_method .pinyin");this._resultTarget=document.querySelector("#web_input_method .result ol");var b=this;var a=document.querySelector("#textarea_id");this._input=a;a.addEventListener("keydown",function(f){var d=f.keyCode;var c=false;if(f.ctrlKey||f.metaKey){console.log(d)}else{if(d>=65&&d<=90){b.addChar(String.fromCharCode(d+32));c=true}else{if(d==8&&b.pinyin){b.delChar();c=true}else{if(d>=48&&d<=57&&!f.shiftKey&&b.pinyin){b.chooseCharacter(d-48);c=true}else{if(d==32&&b.pinyin){b.chooseCharacter(1);c=true}else{if(d==33&&b.pageCount>0&&b.pageCurrent>1){b.pageCurrent--;b.refreshPage();c=true}else{if(d==34&&b.pageCount>0&&b.pageCurrent<b.pageCount){b.pageCurrent++;b.refreshPage();c=true}}}}}}}if(c){f.preventDefault()}});a.addEventListener("focus",function(){if(b._input!==this){b.hide()}})},pinyinToHanzi:function(d){var a=this.trie.searchAndUpdate(d);var c=a[0];var b=a[1];if(!c){return[[],d]}var e=pinyin_dict[c];return[e.split("|"),b]},chooseCharacter:function(c){var b=this.result[(this.pageCurrent-1)*this.pageSize+c-1];if(!b){return}this.hanzi+=b;var a=this.pinyin.indexOf("'");if(a>0){this.pinyin=this.pinyin.substr(a+1);this.refreshBox()}else{this._input.value+=this.hanzi;this.hide()}},refreshBox:function(){var a=this.pinyinToHanzi(this.pinyin.replace(/'/g,""));this.result=a[0];this.pinyin=a[1];var b=this.result.length;this.pageCurrent=1;this.pageCount=Math.ceil(b/this.pageSize);this._pinyinTarget.innerHTML=this.hanzi+this.pinyin;this.refreshPage()},refreshPage:function(){var a=[];var b=this.result.slice((this.pageCurrent-1)*this.pageSize,this.pageCurrent*this.pageSize);for(var c=0;c<b.length;c++){a.push('<li data-idx="'+(c+1)+'">'+b[c]+"</li>")}this._target.querySelector(".page-up").style.opacity=this.pageCurrent>1?"1":".3";this._target.querySelector(".page-down").style.opacity=this.pageCurrent<this.pageCount?"1":".3";this._resultTarget.innerHTML=a.join("")},addChar:function(a){if(this.pinyin.length==0){this.show()}this.originalPinyin+=a;this.pinyin=this.originalPinyin;this.refreshBox()},delChar:function(){if(this.pinyin.length<=1){this.hide();return}this.originalPinyin=this.originalPinyin.substr(0,this.originalPinyin.length-1);this.pinyin=this.originalPinyin;this.refreshBox()},show:function(){this._target.style.display="block"},hide:function(){this.reset();this._target.style.display="none"},reset:function(){this.hanzi="";this.originalPinyin="";this.pinyin="";this.result=[];this.pageCurrent=1;this.pageCount=0;this._pinyinTarget.innerHTML=""}};