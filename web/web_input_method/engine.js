function Trie(a){this.ch=a;this.word="";this.children={}}Trie.prototype.print=function(b){var e="<br/>";var a="&nbsp&nbsp";var f=new Array(b+1).join(a);var d=[];d.push(f+this.ch+":["+this.word+"]");for(var c in this.children){d.push(this.children[c].print(b+1))}return d.join(e)};Trie.prototype.insert=function(d,a){if(a>=d.length){return}var c=d.charAt(a);if(!(c in this.children)){this.children[c]=new Trie(c)}var b=this.children[c];if(a+1==d.length){b.word=d}else{b.insert(d,a+1)}};Trie.prototype.nextWord=function(){if(this.word!=""){return this.word}for(var a in this.children){return this.children[a].nextWord()}console.log("SHOULD NOT HAPPEN: this Trie contains an invalid leaf");return NaN};Trie.prototype._searchHelp=function(e,b,a){if(this.word!=""){a=this.word}if(b>=e.length){if(!a){return[b,this.nextWord()]}return[b,a]}var d=e.charAt(b);if(d in this.children){var c=this.children[d];return c._searchHelp(e,b+1,a)}return[b,a]};Trie.prototype.searchAndUpdate=function(c){var a=this._searchHelp(c,0,"");var e=a[0];var b=a[1];var d=c;if(e<c.length){d=c.substr(0,e)+"'"+c.substr(e,c.length-e)}return[b,d]};var WebInputMethod={hanzi:"",originalPinyin:"",pinyin:"",result:[],pageCurrent:1,pageSize:9,pageCount:0,initDict:function(){if(!pinyin_dict){throw"no dictionary file"}this.trie=new Trie("_");for(var a in pinyin_dict){this.trie.insert(a,0)}},initDom:function(){var b=document.querySelector("#web_input_method");var a=this;b.addEventListener("click",function(d){var c=d.target;if(c.nodeName=="LI"){a.chooseCharacter(parseInt(c.dataset.idx))}else{if(c.nodeName=="SPAN"){if(c.className=="page-up"&&a.pageCurrent>1){a.pageCurrent--;a.refreshPage()}else{if(c.className=="page-down"&&a.pageCurrent<a.pageCount){a.pageCurrent++;a.refreshPage()}}}}});document.body.appendChild(b)},initAll:function(a){this.initDict();this.initDom();var d=document.querySelectorAll(a);this._target=document.querySelector("#web_input_method");this._pinyinTarget=document.querySelector("#web_input_method .pinyin");this._resultTarget=document.querySelector("#web_input_method .result ol");var c=this;for(var b=0;b<d.length;b++){d[b].addEventListener("keydown",function(h){var g=h.keyCode;var f=false;if(h.ctrlKey||h.metaKey){console.log(g)}else{if(g>=65&&g<=90){c.addChar(String.fromCharCode(g+32),this);f=true}else{if(g==8&&c.pinyin){c.delChar();f=true}else{if(g>=48&&g<=57&&!h.shiftKey&&c.pinyin){c.chooseCharacter(g-48);f=true}else{if(g==32&&c.pinyin){c.chooseCharacter(1);f=true}else{if(g==33&&c.pageCount>0&&c.pageCurrent>1){c.pageCurrent--;c.refreshPage();f=true}else{if(g==34&&c.pageCount>0&&c.pageCurrent<c.pageCount){c.pageCurrent++;c.refreshPage();f=true}}}}}}}if(f){h.preventDefault()}});d[b].addEventListener("focus",function(){if(c._input!==this){c.hide()}})}},pinyinToHanzi:function(d){var a=this.trie.searchAndUpdate(d);var c=a[0];var b=a[1];if(!c){return[[],d]}var e=pinyin_dict[c];return[e.split("|"),b]},chooseCharacter:function(c){var b=this.result[(this.pageCurrent-1)*this.pageSize+c-1];if(!b){return}this.hanzi+=b;var a=this.pinyin.indexOf("'");if(a>0){this.pinyin=this.pinyin.substr(a+1);this.refreshBox()}else{this._input.value+=this.hanzi;this.hide()}},refreshBox:function(){var a=this.pinyinToHanzi(this.pinyin.replace(/'/g,""));this.result=a[0];this.pinyin=a[1];var b=this.result.length;this.pageCurrent=1;this.pageCount=Math.ceil(b/this.pageSize);this._pinyinTarget.innerHTML=this.hanzi+this.pinyin;this.refreshPage()},refreshPage:function(){var a=[];var b=this.result.slice((this.pageCurrent-1)*this.pageSize,this.pageCurrent*this.pageSize);for(var c=0;c<b.length;c++){a.push('<li data-idx="'+(c+1)+'">'+b[c]+"</li>")}this._target.querySelector(".page-up").style.opacity=this.pageCurrent>1?"1":".3";this._target.querySelector(".page-down").style.opacity=this.pageCurrent<this.pageCount?"1":".3";this._resultTarget.innerHTML=a.join("")},addChar:function(a,b){if(this.pinyin.length==0){this.show(b)}this.originalPinyin+=a;this.pinyin=this.originalPinyin;this.refreshBox()},delChar:function(){if(this.pinyin.length<=1){this.hide();return}this.originalPinyin=this.originalPinyin.substr(0,this.originalPinyin.length-1);this.pinyin=this.originalPinyin;this.refreshBox()},show:function(a){var b=a.getBoundingClientRect();this._target.style.left=b.left+"px";this._target.style.top=b.top+b.height+document.body.scrollTop+"px";this._input=a;this._target.style.display="block"},hide:function(){this.reset();this._target.style.display="none"},reset:function(){this.hanzi="";this.originalPinyin="";this.pinyin="";this.result=[];this.pageCurrent=1;this.pageCount=0;this._pinyinTarget.innerHTML=""}};